@model Appointment
@{
    ViewData["Title"] = "Advanced Booking System";
    var selectedCar = ViewBag.SelectedCar as Car;
}

@section Styles {
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --glass-bg: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.2);
    }

    .booking-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .car-preview-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .car-preview-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: pulse 4s ease-in-out infinite;
    }

    @@keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }

    .price-calculator {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 1rem;
        position: sticky;
        top: 20px;
    }

    .price-breakdown {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .price-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .price-item:last-child {
        border-bottom: none;
        font-size: 1.5rem;
        font-weight: bold;
        margin-top: 0.5rem;
        padding-top: 1rem;
        border-top: 2px solid white;
    }

    .timeline {
        position: relative;
        padding: 2rem 0;
    }

    .timeline-item {
        position: relative;
        padding-left: 3rem;
        margin-bottom: 2rem;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-gradient);
        border: 3px solid white;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
    }

    .timeline-item::after {
        content: '';
        position: absolute;
        left: 9px;
        top: 20px;
        width: 2px;
        height: calc(100% + 0.5rem);
        background: linear-gradient(to bottom, #667eea, #764ba2);
    }

    .timeline-item:last-child::after {
        display: none;
    }

    .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }

    .feature-box {
        background: rgba(102, 126, 234, 0.1);
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.3s ease;
    }

    .feature-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    }

    .feature-box i {
        font-size: 2.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
    }

    .calendar-wrapper {
        position: relative;
    }

    .calendar-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #667eea;
        pointer-events: none;
    }

    .promo-input-wrapper {
        position: relative;
    }

    .promo-check {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #28a745;
        display: none;
    }

    .availability-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .available {
        background: #d4edda;
        color: #155724;
    }

    .unavailable {
        background: #f8d7da;
        color: #721c24;
    }

    .btn-booking {
        background: var(--primary-gradient);
        border: none;
        color: white;
        padding: 1rem 2rem;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-booking:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        color: white;
    }

    .input-group-advanced {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .input-group-advanced label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
    }
    
    /* Dark mode support */
    [data-theme="dark"] .input-group-advanced label,
    [data-theme="dark"] * {
        color: var(--text-primary, #f9fafb) !important;
    }

    .input-group-advanced input,
    .input-group-advanced select,
    .input-group-advanced textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .input-group-advanced input:focus,
    .input-group-advanced select:focus,
    .input-group-advanced textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    @@media (max-width: 768px) {
        .booking-container {
            padding: 1rem 0;
        }
        .glass-card {
            padding: 1.5rem;
        }
    }
</style>
}

<div class="booking-container">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                @if (selectedCar != null)
                {
                    <div class="car-preview-card">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="mb-3"><i class="fas fa-car"></i> @selectedCar.DisplayName</h2>
                                <div class="feature-grid">
                                    <div class="feature-box">
                                        <i class="fas fa-dollar-sign"></i>
                                        <div><strong>$@selectedCar.DailyRate</strong><br><small>/day</small></div>
                                    </div>
                                    @if (selectedCar.IsElectric)
                                    {
                                        <div class="feature-box">
                                            <i class="fas fa-bolt"></i>
                                            <div><strong>@selectedCar.Range</strong><br><small>miles range</small></div>
                                        </div>
                                        <div class="feature-box">
                                            <i class="fas fa-battery-full"></i>
                                            <div><strong>@selectedCar.BatteryCapacity</strong><br><small>kWh battery</small></div>
                                        </div>
                                    }
                                    <div class="feature-box">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <div><strong>@selectedCar.City</strong><br><small>@selectedCar.State</small></div>
                                    </div>
                                </div>
                                <span class="availability-badge available">
                                    <i class="fas fa-check-circle"></i> Available Now
                                </span>
                            </div>
                            <div class="col-md-4 text-center">
                                <img src="@(selectedCar.ImageUrl ?? "https://via.placeholder.com/300x200")" 
                                     alt="@selectedCar.DisplayName" 
                                     class="img-fluid rounded" 
                                     style="max-height: 200px; object-fit: cover;">
                            </div>
                        </div>
                    </div>
                }

                <div class="glass-card card-3d">
                    <h3 class="mb-4"><i class="fas fa-calendar-alt"></i> Booking Timeline</h3>
                    
                    <form asp-action="Create" method="post" id="bookingForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="carIdHidden" name="CarId" value="@(selectedCar?.Id ?? 0)" />
                        <input type="hidden" id="subscriptionIdHidden" name="SubscriptionId" />
                        @if (TempData["ErrorMessage"] != null && !string.IsNullOrWhiteSpace(TempData["ErrorMessage"]?.ToString()))
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <span class="material-symbols-outlined me-2" style="font-size: 1.25rem; vertical-align: middle;">error</span>
                                <strong>Error:</strong> @TempData["ErrorMessage"]
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        }
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" style="display: @(ViewData.ModelState.ErrorCount > 0 ? "block" : "none");"></div>

                        <div class="timeline">
                            <div class="timeline-item">
                                <h5><i class="fas fa-car"></i> Select Your Vehicle</h5>
                                <div class="input-group-advanced">
                                    <label asp-for="CarId">Choose a Car *</label>
                                    <select asp-for="CarId" class="form-select" asp-items="ViewBag.Cars" required id="carSelect">
                                        <option value="">-- Select a car --</option>
                                    </select>
                                    <span asp-validation-for="CarId" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="timeline-item">
                                <h5><i class="fas fa-calendar-check"></i> Select Available Time Slot</h5>
                                
                                <div id="availableSlotsContainer">
                                @if (selectedCar != null)
                                {
                                    var availableSlots = ViewBag.AvailableSlots as List<(DateTime Start, DateTime End)> ?? new List<(DateTime Start, DateTime End)>();
                                    var preSelectedStartDate = ViewBag.PreSelectedStartDate as DateTime?;
                                    var preSelectedEndDate = ViewBag.PreSelectedEndDate as DateTime?;
                                    
                                    if (availableSlots.Any())
                                    {
                                        <div class="alert alert-info mb-3">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Select an available time slot below, or manually enter dates:</strong>
                                        </div>
                                        
                                        <div class="available-slots-container mb-4" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; background: #f9fafb;">
                                            @foreach (var slot in availableSlots.Take(15))
                                            {
                                                var duration = slot.End - slot.Start;
                                                var days = (int)Math.Ceiling(duration.TotalDays);
                                                var isPreSelected = preSelectedStartDate.HasValue && 
                                                                    preSelectedEndDate.HasValue &&
                                                                    slot.Start == preSelectedStartDate.Value &&
                                                                    slot.End == preSelectedEndDate.Value;
                                                
                                                <div class="slot-card mb-2 p-3 border rounded-2 @(isPreSelected ? "border-primary border-2 selected-slot" : "")" 
                                                     data-start="@slot.Start.ToString("yyyy-MM-ddTHH:mm")"
                                                     data-end="@slot.End.ToString("yyyy-MM-ddTHH:mm")"
                                                     style="cursor: pointer; transition: all 0.2s ease; background: @(isPreSelected ? "#e0f2fe" : "white"); border-color: @(isPreSelected ? "var(--primary)" : "#e5e7eb");" 
                                                     onclick="selectTimeSlotInForm(this, '@slot.Start.ToString("yyyy-MM-ddTHH:mm")', '@slot.End.ToString("yyyy-MM-ddTHH:mm")')"
                                                     onmouseover="if(!this.classList.contains('selected-slot')) this.style.background='#f0f4ff'; this.style.borderColor='var(--primary)';"
                                                     onmouseout="if(!this.classList.contains('selected-slot')) this.style.background='@(isPreSelected ? "#e0f2fe" : "white")'; this.style.borderColor='@(isPreSelected ? "var(--primary)" : "#e5e7eb")';">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <div class="fw-semibold">
                                                                <span class="material-symbols-outlined me-1" style="font-size: 1rem; vertical-align: middle;">event</span>
                                                                @slot.Start.ToString("MMM dd, yyyy HH:mm")
                                                            </div>
                                                            <div class="text-muted small">
                                                                <span class="material-symbols-outlined me-1" style="font-size: 0.875rem; vertical-align: middle;">history</span>
                                                                Until @slot.End.ToString("MMM dd, yyyy HH:mm")
                                                            </div>
                                                        </div>
                                                        <div class="text-end">
                                                            <div class="fw-bold text-primary">@days day@(days != 1 ? "s" : "")</div>
                                                            <div class="text-muted small">RM @(selectedCar.DailyRate * days)</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                            @if (availableSlots.Count > 15)
                                            {
                                                <div class="text-center text-muted small mt-2">
                                                    Showing first 15 slots. More available slots can be selected manually.
                                                </div>
                                            }
                                        </div>
                                        
                                        @if (preSelectedStartDate.HasValue && preSelectedEndDate.HasValue)
                                        {
                                            <script>
                                                document.addEventListener('DOMContentLoaded', function() {
                                                    const preSelectedCard = document.querySelector(`[data-start="@preSelectedStartDate.Value.ToString("yyyy-MM-ddTHH:mm")"][data-end="@preSelectedEndDate.Value.ToString("yyyy-MM-ddTHH:mm")"]`);
                                                    if (preSelectedCard) {
                                                        selectTimeSlotInForm(preSelectedCard, '@preSelectedStartDate.Value.ToString("yyyy-MM-ddTHH:mm")', '@preSelectedEndDate.Value.ToString("yyyy-MM-ddTHH:mm")');
                                                    }
                                                });
                                            </script>
                                        }
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning mb-3">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            No available time slots found for the next 30 days. Please select dates manually below.
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Please select a vehicle first to see available time slots.</strong>
                                    </div>
                                }
                                </div>
                                
                                <div class="mt-3">
                                    <h6 class="fw-semibold mb-3">Or Enter Dates Manually:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="input-group-advanced">
                                                <label asp-for="StartDate">Pickup Date & Time *</label>
                                                <div class="calendar-wrapper">
                                                    <input asp-for="StartDate" type="datetime-local" class="form-control" id="startDate" required />
                                                    <i class="fas fa-calendar-alt calendar-icon"></i>
                                                </div>
                                                <span asp-validation-for="StartDate" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="input-group-advanced">
                                                <label asp-for="EndDate">Return Date & Time *</label>
                                                <div class="calendar-wrapper">
                                                    <input asp-for="EndDate" type="datetime-local" class="form-control" id="endDate" required />
                                                    <i class="fas fa-calendar-alt calendar-icon"></i>
                                                </div>
                                                <span asp-validation-for="EndDate" class="text-danger"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-item">
                                <h5><i class="fas fa-user"></i> Your Information</h5>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Your account information will be used for this booking.
                                </div>
                                <input type="hidden" asp-for="CustomerName" />
                                <input type="hidden" asp-for="CustomerEmail" />
                                <input type="hidden" asp-for="CustomerPhone" />
                            </div>

                            <div class="timeline-item">
                                <h5><i class="fas fa-tags"></i> Apply Discounts</h5>
                                <div class="input-group-advanced">
                                    <label>Promotion Code</label>
                                    <div class="promo-input-wrapper">
                                        <input type="text" id="promotionCode" name="PromotionCode" class="form-control" placeholder="Enter promotion code">
                                        <i class="fas fa-check-circle promo-check" id="promoCheck"></i>
                                    </div>
                                    <small class="text-muted">Enter a valid promotion code for additional discounts</small>
                                    <div id="promotionMessage" class="mt-2"></div>
                                    <input type="hidden" id="promotionId" name="PromotionId" />
                                </div>
                                <div class="input-group-advanced">
                                    <label asp-for="SubscriptionId">Subscription Plan (Optional)</label>
                                    <select asp-for="SubscriptionId" class="form-select" asp-items="ViewBag.Subscriptions" id="subscriptionSelect">
                                        <option value="">-- No subscription --</option>
                                    </select>
                                    <small class="text-muted">Select a subscription plan (e.g., Elite) to get discount on your booking.</small>
                                    <div id="subscriptionInfo" class="mt-2" style="display: none;">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> <span id="subscriptionDiscountInfo"></span>
                                        </div>
                                    </div>
                                    <span asp-validation-for="SubscriptionId" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="timeline-item">
                                <h5><i class="fas fa-comments"></i> Special Requests</h5>
                                <div class="input-group-advanced">
                                    <label asp-for="SpecialRequests">Additional Notes</label>
                                    <textarea asp-for="SpecialRequests" class="form-control" rows="4" placeholder="Any special requests or notes for your booking..."></textarea>
                                    <span asp-validation-for="SpecialRequests" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-booking btn-lg w-100" id="submitBtn">
                                <i class="fas fa-check-circle"></i> <span id="submitBtnText">Confirm & Book Now</span>
                                <span id="submitBtnSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;" role="status" aria-hidden="true"></span>
                            </button>
                            <a asp-controller="Cars" asp-action="Index" class="btn btn-outline-secondary mt-2">
                                <i class="fas fa-arrow-left"></i> Back to Cars
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="price-calculator card-3d">
                    <h4 class="mb-3"><i class="fas fa-calculator"></i> Price Calculator</h4>
                    <div class="price-breakdown" id="priceBreakdown">
                        <div class="price-item">
                            <span>Base Rate (per day)</span>
                            <span id="baseRate" class="fw-bold">RM 0.00</span>
                        </div>
                        <div class="price-item">
                            <span>Rental Days</span>
                            <span id="daysCount" class="fw-semibold">-</span>
                        </div>
                        <div class="price-item">
                            <span>Subtotal</span>
                            <span id="subtotal" class="fw-semibold">RM 0.00</span>
                        </div>
                        <div class="price-item" id="promotionDiscountRow" style="display: none;">
                            <span>Promotion Discount</span>
                            <span id="promotionDiscount" class="text-success fw-semibold">-RM 0.00</span>
                        </div>
                        <div class="price-item" id="subscriptionDiscountRow" style="display: none;">
                            <span>Subscription Discount</span>
                            <span id="subscriptionDiscount" class="text-success fw-semibold">-RM 0.00</span>
                        </div>
                        <div class="price-item mt-2 pt-2 border-top border-white border-opacity-50" style="font-weight: 700; font-size: 1.1rem;">
                            <span>Total Price</span>
                            <span id="totalPrice" class="fw-bold" style="font-size: 1.35rem; color: var(--primary);">RM 0.00</span>
                        </div>
                        <div class="mt-3 pt-3 border-top border-white border-opacity-25">
                            <small class="text-white-50 d-block">
                                <i class="fas fa-info-circle me-1"></i> 
                                <span id="priceCalculatorStatus">Select a vehicle and dates to see pricing</span>
                            </small>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6><i class="fas fa-shield-alt"></i> What's Included</h6>
                        <ul class="list-unstyled mt-3">
                            <li><i class="fas fa-check"></i> 24/7 Roadside Assistance</li>
                            <li><i class="fas fa-check"></i> Free Cancellation</li>
                            <li><i class="fas fa-check"></i> Insurance Coverage</li>
                            <li><i class="fas fa-check"></i> GPS Navigation</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Initialize selected car and daily rate
        @{
            Car? selectedCar = ViewBag.SelectedCar as Car;
            string selectedCarJson = "null";
            if (selectedCar != null)
            {
                // Only serialize necessary properties to avoid circular reference
                selectedCarJson = System.Text.Json.JsonSerializer.Serialize(new {
                    id = selectedCar.Id,
                    make = selectedCar.Make,
                    model = selectedCar.Model,
                    year = selectedCar.Year,
                    displayName = selectedCar.DisplayName,
                    dailyRate = selectedCar.DailyRate,
                    isElectric = selectedCar.IsElectric,
                    imageUrl = selectedCar.ImageUrl,
                    description = selectedCar.Description,
                    state = selectedCar.State,
                    city = selectedCar.City
                });
            }
        }
        let selectedCar = @Html.Raw(selectedCarJson);
        let dailyRate = 0;
        let promotionDiscount = 0;
        let subscriptionDiscount = 0;
        
        // Function to load car details and initialize price calculation
        function loadCarDetailsAndCalculate(carId) {
            return new Promise((resolve, reject) => {
                if (!carId) {
                    dailyRate = 0;
                    calculatePrice();
                    resolve();
                    return;
                }
                
                fetch(`/Cars/GetCarDetails/${carId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Car not found');
                        return response.json();
                    })
                    .then(data => {
                        dailyRate = parseFloat(data.dailyRate) || 0;
                        selectedCar = data;
                        // Update hidden field and select dropdown
                        const carIdHidden = document.getElementById('carIdHidden');
                        if (carIdHidden) carIdHidden.value = carId;
                        const carSelect = document.getElementById('carSelect');
                        if (carSelect) carSelect.value = carId;
                        console.log('Car loaded:', data, 'Daily rate:', dailyRate);
                        // Force price calculation immediately after car is loaded
                        setTimeout(() => {
                            calculatePrice();
                            console.log('Price recalculated after car load');
                        }, 100);
                        resolve(data);
                    })
                    .catch(error => {
                        console.error('Error loading car details:', error);
                        dailyRate = 0;
                        calculatePrice();
                        reject(error);
                    });
            });
        }
        
        // Set daily rate from selected car or URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const carIdParam = urlParams.get('carId');
        
        // Initialize dailyRate immediately if selectedCar is available
        if (selectedCar && selectedCar.dailyRate !== undefined) {
            dailyRate = parseFloat(selectedCar.dailyRate) || 0;
            console.log('Using selectedCar from ViewBag. Daily rate:', dailyRate);
        }
        
        // If we have a carId from URL but no rate yet, load it
        if (carIdParam && (!selectedCar || !dailyRate)) {
            console.log('Loading car from URL param:', carIdParam);
            loadCarDetailsAndCalculate(carIdParam);
        }
        
        // Also check car select dropdown
        const carSelect = document.getElementById('carSelect');
        if (carSelect && carSelect.value && !dailyRate) {
            console.log('Loading car from select:', carSelect.value);
            loadCarDetailsAndCalculate(carSelect.value);
        }

        // Declare pickers first to avoid reference errors
        let startDatePicker, endDatePicker;

        // Initialize Flatpickr for better date picker with validation
        startDatePicker = flatpickr("#startDate", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            altInput: true,
            altFormat: "F j, Y H:i",
            minDate: "today",
            time_24hr: true,
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    const startDate = selectedDates[0];
                    const startDateInput = document.getElementById('startDate');
                    if (startDateInput) {
                        // Sync to native input in ISO 8601 format for form submission
                        const year = startDate.getFullYear();
                        const month = String(startDate.getMonth() + 1).padStart(2, '0');
                        const day = String(startDate.getDate()).padStart(2, '0');
                        const hours = String(startDate.getHours()).padStart(2, '0');
                        const minutes = String(startDate.getMinutes()).padStart(2, '0');
                        startDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                    }
                    
                    // Update end date picker minimum date to start date
                    if (typeof endDatePicker !== 'undefined' && endDatePicker) {
                        endDatePicker.set('minDate', startDate);
                        
                        // If end date is before start date, update it
                        const endDate = endDatePicker.selectedDates[0];
                        if (endDate && endDate < startDate) {
                            endDatePicker.setDate(new Date(startDate.getTime() + 60 * 60 * 1000)); // Set to start date + 1 hour
                        }
                    }
                }
                // Immediately calculate price when start date changes
                setTimeout(() => {
                    if (typeof calculatePrice === 'function') {
                        calculatePrice();
                    }
                    if (typeof validateDates === 'function') {
                        validateDates();
                    }
                }, 50);
            },
            onClose: function(selectedDates, dateStr, instance) {
                // Also sync and calculate when picker closes
                if (selectedDates.length > 0) {
                    const startDate = selectedDates[0];
                    const startDateInput = document.getElementById('startDate');
                    if (startDateInput) {
                        const year = startDate.getFullYear();
                        const month = String(startDate.getMonth() + 1).padStart(2, '0');
                        const day = String(startDate.getDate()).padStart(2, '0');
                        const hours = String(startDate.getHours()).padStart(2, '0');
                        const minutes = String(startDate.getMinutes()).padStart(2, '0');
                        startDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                    }
                }
                setTimeout(() => {
                    if (typeof calculatePrice === 'function') {
                        calculatePrice();
                    }
                }, 50);
            }
        });

        endDatePicker = flatpickr("#endDate", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            altInput: true,
            altFormat: "F j, Y H:i",
            minDate: defaultStartDate || "today",
            time_24hr: true,
            defaultDate: defaultEndDate,
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    const startDate = startDatePicker.selectedDates[0];
                    const endDate = selectedDates[0];
                    const endDateInput = document.getElementById('endDate');
                    
                    // Validate end date is after start date
                    if (startDate && endDate && endDate <= startDate) {
                        // Automatically set end date to start date + 1 hour minimum
                        const minEndDate = new Date(startDate.getTime() + 60 * 60 * 1000); // 1 hour later
                        endDatePicker.setDate(minEndDate);
                        
                        // Show error message
                        showDateError('End date must be after start date. Automatically adjusted to minimum duration.');
                        
                        // Update the input value after adjustment
                        if (endDateInput) {
                            const adjustedDate = new Date(startDate.getTime() + 60 * 60 * 1000);
                            const year = adjustedDate.getFullYear();
                            const month = String(adjustedDate.getMonth() + 1).padStart(2, '0');
                            const day = String(adjustedDate.getDate()).padStart(2, '0');
                            const hours = String(adjustedDate.getHours()).padStart(2, '0');
                            const minutes = String(adjustedDate.getMinutes()).padStart(2, '0');
                            endDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                        }
                    } else {
                        // Sync to native input in ISO 8601 format for form submission
                        if (endDateInput) {
                            const year = endDate.getFullYear();
                            const month = String(endDate.getMonth() + 1).padStart(2, '0');
                            const day = String(endDate.getDate()).padStart(2, '0');
                            const hours = String(endDate.getHours()).padStart(2, '0');
                            const minutes = String(endDate.getMinutes()).padStart(2, '0');
                            endDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                        }
                        
                        // Validate minimum duration
                        if (startDate && endDate) {
                            const durationHours = (endDate - startDate) / (1000 * 60 * 60);
                            if (durationHours < 1) {
                                const minEndDate = new Date(startDate.getTime() + 60 * 60 * 1000);
                                endDatePicker.setDate(minEndDate);
                                if (endDateInput) {
                                    const adjustedDate = new Date(startDate.getTime() + 60 * 60 * 1000);
                                    const year = adjustedDate.getFullYear();
                                    const month = String(adjustedDate.getMonth() + 1).padStart(2, '0');
                                    const day = String(adjustedDate.getDate()).padStart(2, '0');
                                    const hours = String(adjustedDate.getHours()).padStart(2, '0');
                                    const minutes = String(adjustedDate.getMinutes()).padStart(2, '0');
                                    endDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                                }
                                showDateError('Rental duration must be at least 1 hour. Automatically adjusted.');
                            } else {
                                clearDateError();
                            }
                        }
                    }
                }
                
                if (typeof validateDates === 'function') {
                    validateDates();
                }
                // Immediately calculate price when end date changes
                if (typeof calculatePrice === 'function') {
                    calculatePrice();
                }
            },
            onClose: function(selectedDates, dateStr, instance) {
                // Also sync and calculate when picker closes
                if (selectedDates.length > 0) {
                    const endDate = selectedDates[0];
                    const endDateInput = document.getElementById('endDate');
                    if (endDateInput) {
                        const year = endDate.getFullYear();
                        const month = String(endDate.getMonth() + 1).padStart(2, '0');
                        const day = String(endDate.getDate()).padStart(2, '0');
                        const hours = String(endDate.getHours()).padStart(2, '0');
                        const minutes = String(endDate.getMinutes()).padStart(2, '0');
                        endDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                    }
                }
                setTimeout(() => {
                    if (typeof calculatePrice === 'function') {
                        calculatePrice();
                    }
                }, 50);
            }
        });

        // Also add event listeners to native input fields for direct input
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        if (startDateInput) {
            startDateInput.addEventListener('change', function() {
                setTimeout(() => {
                    if (typeof calculatePrice === 'function') {
                        console.log('Start date changed via native input, recalculating...');
                        calculatePrice();
                    }
                }, 100);
            });
            startDateInput.addEventListener('input', function() {
                setTimeout(() => {
                    if (typeof calculatePrice === 'function') {
                        calculatePrice();
                    }
                }, 200);
            });
        }
        
        if (endDateInput) {
            endDateInput.addEventListener('change', function() {
                setTimeout(() => {
                    if (typeof calculatePrice === 'function') {
                        console.log('End date changed via native input, recalculating...');
                        calculatePrice();
                    }
                }, 100);
            });
            endDateInput.addEventListener('input', function() {
                setTimeout(() => {
                    if (typeof calculatePrice === 'function') {
                        calculatePrice();
                    }
                }, 200);
            });
        }

        function showDateError(message) {
            let errorDiv = document.getElementById('dateError');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'dateError';
                errorDiv.className = 'alert alert-warning alert-dismissible fade show';
                errorDiv.style.marginTop = '0.5rem';
                const endDateGroup = document.querySelector('input[name="EndDate"]').closest('.form-group') || 
                                    document.querySelector('input[name="EndDate"]').parentElement;
                if (endDateGroup) {
                    endDateGroup.appendChild(errorDiv);
                }
            }
            errorDiv.innerHTML = `
                <span class="material-symbols-outlined me-2" style="font-size: 1rem; vertical-align: middle;">warning</span>
                <strong>Warning:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const endDateInput = document.getElementById('endDate');
            if (endDateInput) {
                endDateInput.classList.add('is-invalid');
            }
        }

        function clearDateError() {
            const errorDiv = document.getElementById('dateError');
            if (errorDiv) {
                errorDiv.remove();
            }
            const endDateInput = document.getElementById('endDate');
            if (endDateInput) {
                endDateInput.classList.remove('is-invalid');
            }
        }

        function validateDates() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            if (typeof startDatePicker !== 'undefined' && typeof endDatePicker !== 'undefined' && startDatePicker && endDatePicker) {
                const startDate = startDatePicker.selectedDates[0];
                const endDate = endDatePicker.selectedDates[0];
                
                if (startDate && endDate) {
                    if (endDate <= startDate) {
                        if (endDateInput) {
                            endDateInput.setCustomValidity('End date must be after start date');
                            endDateInput.classList.add('is-invalid');
                        }
                    } else {
                        if (endDateInput) {
                            endDateInput.setCustomValidity('');
                            endDateInput.classList.remove('is-invalid');
                        }
                    }
                }
            }
        }

        // Form validation on submit - ENHANCED
        const bookingForm = document.querySelector('form#bookingForm') || document.querySelector('form');
        if (bookingForm) {
            bookingForm.addEventListener('submit', function(e) {
                // Ensure dates are synced to native inputs before submission (already done in onChange/onClose, but ensure here too)
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                
                if (typeof startDatePicker !== 'undefined' && startDatePicker && startDatePicker.selectedDates.length > 0) {
                    if (startDateInput) {
                        const startDate = startDatePicker.selectedDates[0];
                        // Format as ISO 8601 for datetime-local input
                        const year = startDate.getFullYear();
                        const month = String(startDate.getMonth() + 1).padStart(2, '0');
                        const day = String(startDate.getDate()).padStart(2, '0');
                        const hours = String(startDate.getHours()).padStart(2, '0');
                        const minutes = String(startDate.getMinutes()).padStart(2, '0');
                        startDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                        console.log('Start date synced:', startDateInput.value);
                    }
                } else if (startDateInput && (!startDateInput.value || startDateInput.value.trim() === '')) {
                    e.preventDefault();
                    showDateError('Please select a pickup date and time.');
                    if (startDatePicker) startDatePicker.open();
                    return false;
                }
                
                if (typeof endDatePicker !== 'undefined' && endDatePicker && endDatePicker.selectedDates.length > 0) {
                    if (endDateInput) {
                        const endDate = endDatePicker.selectedDates[0];
                        // Format as ISO 8601 for datetime-local input
                        const year = endDate.getFullYear();
                        const month = String(endDate.getMonth() + 1).padStart(2, '0');
                        const day = String(endDate.getDate()).padStart(2, '0');
                        const hours = String(endDate.getHours()).padStart(2, '0');
                        const minutes = String(endDate.getMinutes()).padStart(2, '0');
                        endDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                        console.log('End date synced:', endDateInput.value);
                    }
                } else if (endDateInput && (!endDateInput.value || endDateInput.value.trim() === '')) {
                    e.preventDefault();
                    showDateError('Please select a return date and time.');
                    if (endDatePicker) endDatePicker.open();
                    return false;
                }
                
                // Double-check native inputs have values (fallback if Flatpickr didn't sync)
                if (startDateInput && (!startDateInput.value || startDateInput.value.trim() === '')) {
                    e.preventDefault();
                    showDateError('Please select a pickup date and time.');
                    if (startDatePicker) startDatePicker.open();
                    return false;
                }
                
                if (endDateInput && (!endDateInput.value || endDateInput.value.trim() === '')) {
                    e.preventDefault();
                    showDateError('Please select a return date and time.');
                    if (endDatePicker) endDatePicker.open();
                    return false;
                }
                
                // Final validation: Ensure we have all required data
                if (!carSelect || !carSelect.value || carSelect.value === '0' || carSelect.value === '') {
                    e.preventDefault();
                    alert('Please select a vehicle to continue with your booking.');
                    if (carSelect) carSelect.focus();
                    return false;
                }
                
                // Show confirmation and disable submit button to prevent double submission
                const submitBtn = document.getElementById('submitBtn');
                const submitBtnText = document.getElementById('submitBtnText');
                const submitBtnSpinner = document.getElementById('submitBtnSpinner');
                
                if (submitBtn && submitBtnText && submitBtnSpinner) {
                    const confirmed = confirm('Are you sure you want to confirm this booking?\n\nPlease verify:\n- Vehicle selected\n- Dates and times\n- Total price\n\nClick OK to proceed with booking.');
                    if (!confirmed) {
                        e.preventDefault();
                        return false;
                    }
                    
                    // Disable submit button and show loading state
                    submitBtn.disabled = true;
                    submitBtnText.textContent = 'Processing...';
                    submitBtnSpinner.style.display = 'inline-block';
                    submitBtn.classList.add('opacity-75');
                }
                
                // Validate dates if pickers are available
                if (typeof startDatePicker !== 'undefined' && typeof endDatePicker !== 'undefined' && startDatePicker && endDatePicker) {
                    const startDate = startDatePicker.selectedDates[0];
                    const endDate = endDatePicker.selectedDates[0];
                    
                    if (!startDate || !endDate) {
                        e.preventDefault();
                        showDateError('Please select both pickup and return dates.');
                        if (startDatePicker) startDatePicker.open();
                        return false;
                    }
                    
                    // Validate dates are not in the past
                    const now = new Date();
                    if (startDate < now) {
                        e.preventDefault();
                        showDateError('Pickup date cannot be in the past!');
                        if (startDatePicker) startDatePicker.open();
                        return false;
                    }
                    
                    if (endDate < now) {
                        e.preventDefault();
                        showDateError('Return date cannot be in the past!');
                        if (endDatePicker) endDatePicker.open();
                        return false;
                    }
                    
                    // Validate end date is after start date
                    if (endDate <= startDate) {
                        e.preventDefault();
                        showDateError('Return date must be after pickup date!');
                        if (endDatePicker) endDatePicker.open();
                        return false;
                    }
                    
                    // Validate minimum rental duration (at least 1 hour)
                    const durationHours = (endDate - startDate) / (1000 * 60 * 60);
                    if (durationHours < 1) {
                        e.preventDefault();
                        showDateError('Rental duration must be at least 1 hour!');
                        if (endDatePicker) endDatePicker.open();
                        return false;
                    }
                }
                
                // Ensure CarId is set from dropdown (primary source) or hidden input (fallback)
                const carIdHidden = document.getElementById('carIdHidden');
                const carSelect = document.getElementById('carSelect');
                
                // Validate car is selected
                if (!carSelect || !carSelect.value || carSelect.value === '0' || carSelect.value === '') {
                    e.preventDefault();
                    const errorMsg = 'Please select a vehicle to continue with your booking.';
                    alert(errorMsg);
                    if (carSelect) carSelect.focus();
                    return false;
                }
                
                // Sync CarId: Always use carSelect value (it's the source of truth)
                // Both hidden input and select have name="CarId", but we sync them to ensure consistency
                if (carSelect && carSelect.value && carSelect.value !== '0' && carSelect.value !== '') {
                    if (carIdHidden) {
                        carIdHidden.value = carSelect.value;
                    }
                    console.log('CarId synced - Select value:', carSelect.value);
                } else {
                    // If select has no valid value, check hidden input
                    if (carIdHidden && carIdHidden.value && carIdHidden.value !== '0' && carIdHidden.value !== '') {
                        if (carSelect) {
                            carSelect.value = carIdHidden.value;
                        }
                        console.log('CarId synced from hidden - Hidden value:', carIdHidden.value);
                    }
                }
                
                // Ensure carSelect has name attribute for form submission (asp-for should add it, but ensure it's there)
                if (carSelect && !carSelect.hasAttribute('name')) {
                    carSelect.setAttribute('name', 'CarId');
                }
                
                // Final validation: Ensure CarId is definitely set (check both)
                const finalCarId = (carSelect && carSelect.value) ? carSelect.value : (carIdHidden ? carIdHidden.value : null);
                if (!finalCarId || finalCarId === '0' || finalCarId === '') {
                    e.preventDefault();
                    alert('Please select a vehicle to continue with your booking.');
                    if (carSelect) carSelect.focus();
                    return false;
                }
                
                // Ensure both fields have the correct value before submission
                if (carSelect && carSelect.value) {
                    if (carIdHidden) carIdHidden.value = carSelect.value;
                } else if (carIdHidden && carIdHidden.value) {
                    if (carSelect) carSelect.value = carIdHidden.value;
                }
                
                // Ensure SubscriptionId is set from dropdown
                const subscriptionIdHidden = document.getElementById('subscriptionIdHidden');
                const subscriptionSelect = document.getElementById('subscriptionSelect');
                if (subscriptionIdHidden && subscriptionSelect) {
                    if (subscriptionSelect.value && subscriptionSelect.value !== '' && subscriptionSelect.value !== '0') {
                        subscriptionIdHidden.value = subscriptionSelect.value;
                        // Also ensure the select has name for form submission
                        if (!subscriptionSelect.hasAttribute('name') || subscriptionSelect.getAttribute('name') !== 'SubscriptionId') {
                            subscriptionSelect.setAttribute('name', 'SubscriptionId');
                        }
                    } else {
                        subscriptionIdHidden.value = '';
                    }
                }
                
                // Ensure PromotionId is set from hidden input if promotion code was validated
                const promotionIdHidden = document.getElementById('promotionId');
                if (promotionIdHidden && promotionIdHidden.value) {
                    // PromotionId is already set from promotion code validation
                }
                
                // Final console log for debugging
                console.log('Form submission data:', {
                    carId: carSelect ? carSelect.value : 'N/A',
                    startDate: startDateInput ? startDateInput.value : 'N/A',
                    endDate: endDateInput ? endDateInput.value : 'N/A',
                    subscriptionId: subscriptionSelect ? subscriptionSelect.value : 'N/A',
                    promotionId: promotionIdHidden ? promotionIdHidden.value : 'N/A'
                });
                
                clearDateError();
                
                // Allow form submission to proceed
            });
            
            // Re-enable submit button if form validation fails and page doesn't reload
            window.addEventListener('pageshow', function(event) {
                const submitBtn = document.getElementById('submitBtn');
                const submitBtnText = document.getElementById('submitBtnText');
                const submitBtnSpinner = document.getElementById('submitBtnSpinner');
                
                if (submitBtn && submitBtnText && submitBtnSpinner) {
                    submitBtn.disabled = false;
                    submitBtnText.textContent = 'Confirm & Book Now';
                    submitBtnSpinner.style.display = 'none';
                    submitBtn.classList.remove('opacity-75');
                }
            });
        }

        // Function to load available slots for selected car
        async function loadAvailableSlots(carId) {
            if (!carId || carId === '0' || carId === '') {
                return;
            }
            
            try {
                // Fetch available slots from server
                const response = await fetch(`/Appointments/GetAvailableSlots?carId=${carId}`);
                if (!response.ok) {
                    throw new Error('Failed to load available slots');
                }
                const slots = await response.json();
                
                const slotsContainer = document.getElementById('availableSlotsContainer');
                if (!slotsContainer) return;
                
                if (slots && slots.length > 0) {
                    let html = '<div class="alert alert-info mb-3"><i class="fas fa-info-circle me-2"></i><strong>Select an available time slot below, or manually enter dates:</strong></div>';
                    html += '<div class="available-slots-container mb-4" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; background: #f9fafb;">';
                    
                    slots.slice(0, 15).forEach(slot => {
                        const startDate = new Date(slot.start);
                        const endDate = new Date(slot.end);
                        const duration = endDate - startDate;
                        const days = Math.ceil(duration / (1000 * 60 * 60 * 24));
                        const price = (dailyRate || 0) * days;
                        
                        const startStr = startDate.toISOString().slice(0, 16);
                        const endStr = endDate.toISOString().slice(0, 16);
                        const formattedStart = startDate.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const formattedEnd = endDate.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        
                        html += `
                            <div class="slot-card mb-2 p-3 border rounded-2" 
                                 data-start="${startStr}"
                                 data-end="${endStr}"
                                 style="cursor: pointer; transition: all 0.2s ease; background: white; border-color: #e5e7eb;" 
                                 onclick="selectTimeSlotInForm(this, '${startStr}', '${endStr}')"
                                 onmouseover="if(!this.classList.contains('selected-slot')) this.style.background='#f0f4ff'; this.style.borderColor='var(--primary)';"
                                 onmouseout="if(!this.classList.contains('selected-slot')) this.style.background='white'; this.style.borderColor='#e5e7eb';">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold">
                                            <span class="material-symbols-outlined me-1" style="font-size: 1rem; vertical-align: middle;">event</span>
                                            ${formattedStart}
                                        </div>
                                        <div class="text-muted small">
                                            <span class="material-symbols-outlined me-1" style="font-size: 0.875rem; vertical-align: middle;">history</span>
                                            Until ${formattedEnd}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold text-primary">${days} day${days !== 1 ? 's' : ''}</div>
                                        <div class="text-muted small">RM ${price.toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    if (slots.length > 15) {
                        html += '<div class="text-center text-muted small mt-2">Showing first 15 slots. More available slots can be selected manually.</div>';
                    }
                    
                    html += '</div>';
                    slotsContainer.innerHTML = html;
                } else {
                    slotsContainer.innerHTML = '<div class="alert alert-warning mb-3"><i class="fas fa-exclamation-triangle me-2"></i>No available time slots found for the next 30 days. Please select dates manually below.</div>';
                }
            } catch (error) {
                console.error('Error loading available slots:', error);
                const slotsContainer = document.getElementById('availableSlotsContainer');
                if (slotsContainer) {
                    slotsContainer.innerHTML = '<div class="alert alert-warning mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Unable to load available slots. Please select dates manually below.</div>';
                }
            }
        }
        
        // Function to select time slot in form
        function selectTimeSlotInForm(element, startDateStr, endDateStr) {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (startDateInput && endDateInput) {
                // Parse the date strings and format for datetime-local input
                const startDate = new Date(startDateStr);
                const endDate = new Date(endDateStr);
                
                // Format to YYYY-MM-DDTHH:mm for datetime-local input
                const formatDateTime = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}`;
                };
                
                startDateInput.value = formatDateTime(startDate);
                endDateInput.value = formatDateTime(endDate);
                
                // Visual feedback - highlight selected slot
                document.querySelectorAll('.slot-card').forEach(card => {
                    card.classList.remove('selected-slot');
                    const wasPreSelected = card.dataset.start && card.dataset.end;
                    if (!wasPreSelected) {
                        card.style.background = 'white';
                        card.style.borderColor = '#e5e7eb';
                    }
                });
                
                // Highlight the clicked slot
                if (element) {
                    element.classList.add('selected-slot');
                    element.style.background = '#e0f2fe';
                    element.style.borderColor = 'var(--primary)';
                    element.style.borderWidth = '2px';
                }
                
                // Sync with Flatpickr if initialized
                if (typeof startDatePicker !== 'undefined' && startDatePicker) {
                    startDatePicker.setDate(startDate, false);
                }
                if (typeof endDatePicker !== 'undefined' && endDatePicker) {
                    endDatePicker.setDate(endDate, false);
                }
                
                // Force multiple price calculations to ensure it updates
                if (typeof calculatePrice === 'function') {
                    setTimeout(() => {
                        console.log('Calculating price after slot selection...');
                        calculatePrice();
                        // Force another calculation after Flatpickr syncs
                        setTimeout(() => {
                            console.log('Second calculation after slot selection...');
                            calculatePrice();
                        }, 300);
                    }, 100);
                }
                
                // Scroll to manual date inputs
                setTimeout(() => {
                    const manualSection = document.querySelector('.mt-3 h6');
                    if (manualSection) {
                        manualSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 200);
            }
        }
        
        // Car selection change - ensure both hidden input and select stay in sync
        const carSelect = document.getElementById('carSelect') || document.querySelector('select[name="CarId"]');
        if (carSelect) {
            // Ensure select has name attribute for form submission
            if (!carSelect.hasAttribute('name') || carSelect.getAttribute('name') !== 'CarId') {
                carSelect.setAttribute('name', 'CarId');
            }
            
            carSelect.addEventListener('change', function() {
                const carId = this.value;
                const carIdHidden = document.getElementById('carIdHidden');
                
                // Sync hidden input with select value
                if (carIdHidden) {
                    carIdHidden.value = carId || '0';
                }
                
                // Load car details and calculate price
                if (carId && carId !== '0' && carId !== '') {
                    loadCarDetailsAndCalculate(carId);
                    // Load available slots for selected car
                    loadAvailableSlots(carId);
                } else {
                    dailyRate = 0;
                    calculatePrice();
                    // Clear available slots container
                    const slotsContainer = document.getElementById('availableSlotsContainer');
                    if (slotsContainer) {
                        slotsContainer.innerHTML = '<div class="alert alert-info mb-3"><i class="fas fa-info-circle me-2"></i><strong>Please select a vehicle first to see available time slots.</strong></div>';
                    }
                }
            });
            
            // On page load, sync hidden input with select if select has a value
            if (carSelect.value && carSelect.value !== '0' && carSelect.value !== '') {
                const carIdHidden = document.getElementById('carIdHidden');
                if (carIdHidden && (!carIdHidden.value || carIdHidden.value === '0')) {
                    carIdHidden.value = carSelect.value;
                    loadCarDetailsAndCalculate(carSelect.value);
                }
            }
        }

        // Date change handlers - Using Flatpickr events instead
        // These are already handled in the Flatpickr onChange callbacks above

        // Promotion code validation
        let promoCheckTimeout;
        const promotionCodeInput = document.getElementById('promotionCode');
        if (promotionCodeInput) {
            promotionCodeInput.addEventListener('input', function() {
            clearTimeout(promoCheckTimeout);
            const code = this.value.trim();
            const promoCheck = document.getElementById('promoCheck');
            
            if (code.length === 0) {
                promoCheck.style.display = 'none';
                promotionDiscount = 0;
                const promotionIdInput = document.getElementById('promotionId');
                if (promotionIdInput) {
                    promotionIdInput.value = '';
                }
                document.getElementById('promotionMessage').innerHTML = '';
                calculatePrice();
                return;
            }

            promoCheckTimeout = setTimeout(() => {
                const carId = document.getElementById('carSelect').value || (selectedCar ? selectedCar.id : 0);
                if (!carId) {
                    document.getElementById('promotionMessage').innerHTML = 
                        '<div class="alert alert-warning">Please select a car first.</div>';
                    return;
                }

                fetch(`/Appointments/ValidatePromotionCode?code=${encodeURIComponent(code)}&carId=${carId}`)
                    .then(response => response.json())
                    .then(data => {
                        const promotionIdInput = document.getElementById('promotionId');
                        if (data.valid) {
                            promoCheck.style.display = 'block';
                            promotionDiscount = data.discount || 0;
                            // Set PromotionId to hidden input
                            if (promotionIdInput && data.promotionId) {
                                promotionIdInput.value = data.promotionId;
                                console.log('Promotion ID set:', data.promotionId);
                            }
                            document.getElementById('promotionMessage').innerHTML = 
                                `<div class="alert alert-success"><i class="fas fa-check-circle"></i> Valid! ${promotionDiscount}% discount applied.</div>`;
                        } else {
                            promoCheck.style.display = 'none';
                            promotionDiscount = 0;
                            // Clear PromotionId if invalid
                            if (promotionIdInput) {
                                promotionIdInput.value = '';
                            }
                            document.getElementById('promotionMessage').innerHTML = 
                                '<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Invalid or expired code.</div>';
                        }
                        calculatePrice();
                    })
                    .catch(() => {
                        promoCheck.style.display = 'none';
                        promotionDiscount = 0;
                        const promotionIdInput = document.getElementById('promotionId');
                        if (promotionIdInput) {
                            promotionIdInput.value = '';
                        }
                        document.getElementById('promotionMessage').innerHTML = 
                            '<div class="alert alert-danger">Error validating code.</div>';
                        calculatePrice();
                    });
            }, 500);
        });

        // Subscription change handler - ENHANCED
        const subscriptionSelect = document.getElementById('subscriptionSelect');
        const subscriptionIdHidden = document.getElementById('subscriptionIdHidden');
        if (subscriptionSelect) {
            subscriptionSelect.addEventListener('change', function() {
                const subscriptionId = this.value;
                const subscriptionInfo = document.getElementById('subscriptionInfo');
                const subscriptionDiscountInfo = document.getElementById('subscriptionDiscountInfo');
                
                // Update hidden field
                if (subscriptionIdHidden) {
                    subscriptionIdHidden.value = subscriptionId || '';
                }
                
                if (subscriptionId) {
                    // Fetch subscription details to get discount percentage
                    fetch(`/Subscriptions/GetSubscriptionDetails/${subscriptionId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Subscription not found');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.discountPercentage !== undefined) {
                                subscriptionDiscount = parseFloat(data.discountPercentage) || 0;
                                console.log('Subscription discount set:', subscriptionDiscount, '% for plan:', data.name);
                                
                                // Show subscription info
                                if (subscriptionInfo && subscriptionDiscountInfo) {
                                    subscriptionInfo.style.display = 'block';
                                    const planName = data.name || 'Selected Plan';
                                    const monthlyPrice = parseFloat(data.monthlyPrice) || 0;
                                    
                                    subscriptionDiscountInfo.innerHTML = 
                                        `<strong>${planName}</strong> (RM ${monthlyPrice.toFixed(2)}/month): <strong>${subscriptionDiscount}% discount</strong> will be applied to your booking total. The discount amount will be calculated based on your rental duration and shown in the price calculator on the right.`;
                                }
                            } else {
                                subscriptionDiscount = 0;
                                if (subscriptionInfo) subscriptionInfo.style.display = 'none';
                            }
                            // Calculate price first, then update savings info
                            calculatePrice();
                            
                            // Update savings info after price calculation
                            setTimeout(() => {
                                const subtotalEl = document.getElementById('subtotal');
                                let estimatedSavings = '';
                                if (subtotalEl && subscriptionDiscount > 0) {
                                    const subtotalText = subtotalEl.textContent.replace(/[^\d.]/g, '');
                                    const subtotal = parseFloat(subtotalText) || 0;
                                    if (subtotal > 0) {
                                        const savings = (subtotal * subscriptionDiscount) / 100;
                                        estimatedSavings = ` Estimated savings on this booking: <strong>RM ${savings.toFixed(2)}</strong>`;
                                        if (subscriptionDiscountInfo) {
                                            subscriptionDiscountInfo.innerHTML = 
                                                `<strong>${planName || 'Selected Plan'}</strong> (RM ${monthlyPrice.toFixed(2)}/month): <strong>${subscriptionDiscount}% discount</strong> will be applied.${estimatedSavings}`;
                                        }
                                    }
                                }
                            }, 100);
                        })
                        .catch(error => {
                            console.error('Error loading subscription details:', error);
                            subscriptionDiscount = 0;
                            if (subscriptionInfo) subscriptionInfo.style.display = 'none';
                            calculatePrice();
                        });
                } else {
                    subscriptionDiscount = 0;
                    if (subscriptionInfo) subscriptionInfo.style.display = 'none';
                    if (subscriptionIdHidden) subscriptionIdHidden.value = '';
                    calculatePrice();
                }
            });
            
            // Initialize subscription discount on page load if subscription is pre-selected
            if (subscriptionSelect.value) {
                subscriptionSelect.dispatchEvent(new Event('change'));
            }
            
            // Check if subscriptionId is in URL (from subscription page)
            const urlParams = new URLSearchParams(window.location.search);
            const subscriptionIdParam = urlParams.get('subscriptionId');
            if (subscriptionIdParam && subscriptionSelect) {
                subscriptionSelect.value = subscriptionIdParam;
                subscriptionSelect.dispatchEvent(new Event('change'));
            }
        }

        // Price calculation function - ENHANCED to handle all cases
        function calculatePrice() {
            console.log('=== calculatePrice called ===');
            console.log('Current values:', { dailyRate, promotionDiscount, subscriptionDiscount });
            
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            // Try to get dates from Flatpickr instances first, then fallback to input values
            let startDate = null, endDate = null;
            
            // Get start date - try Flatpickr first (most reliable)
            if (typeof startDatePicker !== 'undefined' && startDatePicker && startDatePicker.selectedDates.length > 0) {
                startDate = new Date(startDatePicker.selectedDates[0]);
                console.log('Got startDate from Flatpickr:', startDate);
            } else if (startDateInput && startDateInput.value) {
                // Try native input (datetime-local format: YYYY-MM-DDTHH:mm)
                const startValue = startDateInput.value.trim();
                if (startValue) {
                    startDate = new Date(startValue);
                    // Validate the date
                    if (isNaN(startDate.getTime())) {
                        console.warn('Invalid startDate from input:', startValue);
                        startDate = null;
                    } else {
                        console.log('Got startDate from input:', startDate, 'from value:', startValue);
                    }
                }
            }
            
            // If still no start date, try URL parameter as last resort
            if (!startDate) {
                const urlParams = new URLSearchParams(window.location.search);
                const startDateParam = urlParams.get('startDate');
                if (startDateParam) {
                    const decodedStartDate = decodeURIComponent(startDateParam);
                    startDate = new Date(decodedStartDate);
                    if (!isNaN(startDate.getTime())) {
                        console.log('Got startDate from URL parameter:', startDate);
                        // Set it to input for next time
                        if (startDateInput) {
                            startDateInput.value = decodedStartDate;
                        }
                    } else {
                        startDate = null;
                    }
                }
            }
            
            // Get end date - try Flatpickr first (most reliable)
            if (typeof endDatePicker !== 'undefined' && endDatePicker && endDatePicker.selectedDates.length > 0) {
                endDate = new Date(endDatePicker.selectedDates[0]);
                console.log('Got endDate from Flatpickr:', endDate);
            } else if (endDateInput && endDateInput.value) {
                // Try native input (datetime-local format: YYYY-MM-DDTHH:mm)
                const endValue = endDateInput.value.trim();
                if (endValue) {
                    endDate = new Date(endValue);
                    // Validate the date
                    if (isNaN(endDate.getTime())) {
                        console.warn('Invalid endDate from input:', endValue);
                        endDate = null;
                    } else {
                        console.log('Got endDate from input:', endDate, 'from value:', endValue);
                    }
                }
            }
            
            // If still no end date, try URL parameter as last resort
            if (!endDate) {
                const urlParams = new URLSearchParams(window.location.search);
                const endDateParam = urlParams.get('endDate');
                if (endDateParam) {
                    const decodedEndDate = decodeURIComponent(endDateParam);
                    endDate = new Date(decodedEndDate);
                    if (!isNaN(endDate.getTime())) {
                        console.log('Got endDate from URL parameter:', endDate);
                        // Set it to input for next time
                        if (endDateInput) {
                            endDateInput.value = decodedEndDate;
                        }
                    } else {
                        endDate = null;
                    }
                }
            }
            
            console.log('Final dates:', { startDate, endDate, hasStart: !!startDate, hasEnd: !!endDate });
            
            // Validate we have all required data
            if (!startDate || !endDate || !dailyRate || dailyRate <= 0) {
                // Show "Select dates" message if car is selected but dates aren't
                if (dailyRate > 0 && (!startDate || !endDate)) {
                    updatePriceDisplay(dailyRate, 0, 0, 0, 0, 0, true);
                } else {
                    updatePriceDisplay(0, 0, 0, 0, 0, 0, false);
                }
                return;
            }

            // Validate dates are valid
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                updatePriceDisplay(dailyRate, 0, 0, 0, 0, 0, false);
                return;
            }

            // Validate end date is after start date
            if (endDate <= startDate) {
                updatePriceDisplay(dailyRate, 0, 0, 0, 0, 0, false);
                return;
            }

            // Calculate rental duration
            const diffTime = Math.abs(endDate - startDate);
            const diffHours = diffTime / (1000 * 60 * 60);
            
            // Calculate days: at least 1 day minimum, round up for partial days
            // For hourly rentals, charge per 24-hour period (minimum 1 day)
            let rentalDays;
            if (diffHours < 24) {
                rentalDays = 1; // Minimum 1 day charge
            } else {
                rentalDays = Math.ceil(diffHours / 24); // Round up for partial days
            }
            
            const subtotal = dailyRate * rentalDays;
            
            // Calculate discounts (both promotion and subscription can stack)
            const promoDiscountAmount = (subtotal * promotionDiscount) / 100;
            const subDiscountAmount = (subtotal * subscriptionDiscount) / 100;
            
            // Total after all discounts
            const total = Math.max(0, subtotal - promoDiscountAmount - subDiscountAmount);

            console.log('Price calculation result:', {
                dailyRate,
                rentalDays,
                subtotal: subtotal.toFixed(2),
                promoDiscount: promotionDiscount + '%',
                promoDiscountAmount: promoDiscountAmount.toFixed(2),
                subDiscount: subscriptionDiscount + '%',
                subDiscountAmount: subDiscountAmount.toFixed(2),
                total: total.toFixed(2)
            });

            updatePriceDisplay(dailyRate, rentalDays, subtotal, total, promoDiscountAmount, subDiscountAmount, false);
            console.log('=== calculatePrice completed ===');
            
            // Store last calculation time
            window.lastPriceCalc = Date.now();
        }

        function updatePriceDisplay(rate, days, subtotal, total, promoDiscount = 0, subDiscount = 0, waitingForDates = false) {
            const baseRateEl = document.getElementById('baseRate');
            const daysCountEl = document.getElementById('daysCount');
            const subtotalEl = document.getElementById('subtotal');
            const totalPriceEl = document.getElementById('totalPrice');
            const statusEl = document.getElementById('priceCalculatorStatus');
            
            // Update status message
            if (statusEl) {
                if (rate <= 0) {
                    statusEl.textContent = 'Select a vehicle to see pricing';
                    statusEl.style.color = '';
                } else if (waitingForDates) {
                    statusEl.textContent = 'Select pickup and return dates';
                    statusEl.style.color = '#fbbf24';
                } else if (days > 0) {
                    statusEl.textContent = 'Price includes all applicable discounts';
                    statusEl.style.color = '';
                } else {
                    statusEl.textContent = 'Select dates to calculate total';
                    statusEl.style.color = '';
                }
            }
            
            if (baseRateEl) {
                if (rate > 0) {
                    baseRateEl.textContent = `RM ${rate.toFixed(2)}`;
                    baseRateEl.style.color = '';
                } else {
                    baseRateEl.textContent = 'RM 0.00';
                    baseRateEl.style.opacity = '0.5';
                }
            }
            
            if (daysCountEl) {
                if (waitingForDates && rate > 0) {
                    daysCountEl.textContent = 'Select dates';
                    daysCountEl.style.color = '#fbbf24';
                    daysCountEl.style.fontStyle = 'italic';
                } else if (days > 0) {
                    daysCountEl.textContent = days.toString();
                    daysCountEl.style.color = '';
                    daysCountEl.style.fontStyle = '';
                } else {
                    daysCountEl.textContent = '-';
                    daysCountEl.style.color = '';
                    daysCountEl.style.fontStyle = '';
                }
            }
            
            if (subtotalEl) {
                if (waitingForDates && rate > 0) {
                    subtotalEl.textContent = 'Select dates';
                    subtotalEl.style.color = '#fbbf24';
                    subtotalEl.style.fontStyle = 'italic';
                } else if (subtotal > 0) {
                    subtotalEl.textContent = `RM ${subtotal.toFixed(2)}`;
                    subtotalEl.style.color = '';
                    subtotalEl.style.fontStyle = '';
                } else {
                    subtotalEl.textContent = 'RM 0.00';
                    subtotalEl.style.opacity = '0.5';
                }
            }
            
            if (totalPriceEl) {
                if (waitingForDates && rate > 0) {
                    totalPriceEl.textContent = 'Select dates';
                    totalPriceEl.style.color = '#fbbf24';
                    totalPriceEl.style.fontStyle = 'italic';
                } else if (total > 0) {
                    totalPriceEl.textContent = `RM ${total.toFixed(2)}`;
                    totalPriceEl.style.color = '';
                    totalPriceEl.style.fontStyle = '';
                } else {
                    totalPriceEl.textContent = 'RM 0.00';
                    totalPriceEl.style.opacity = '0.5';
                }
            }
            
            // Show/hide discount rows
            const promoRow = document.getElementById('promotionDiscountRow');
            const subRow = document.getElementById('subscriptionDiscountRow');
            
            if (promoRow) {
                if (promoDiscount > 0 && !waitingForDates) {
                    promoRow.style.display = 'flex';
                    const promoDiscountEl = document.getElementById('promotionDiscount');
                    if (promoDiscountEl) promoDiscountEl.textContent = `-RM ${promoDiscount.toFixed(2)}`;
                } else {
                    promoRow.style.display = 'none';
                }
            }
            
            if (subRow) {
                if (subDiscount > 0 && !waitingForDates) {
                    subRow.style.display = 'flex';
                    const subDiscountEl = document.getElementById('subscriptionDiscount');
                    if (subDiscountEl) subDiscountEl.textContent = `-RM ${subDiscount.toFixed(2)}`;
                } else {
                    subRow.style.display = 'none';
                }
            }
        }

        // Initialize price calculation on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for all elements to be ready, especially Flatpickr
            setTimeout(() => {
                const carSelectEl = document.getElementById('carSelect') || document.querySelector('select[name="CarId"]');
                const urlParams = new URLSearchParams(window.location.search);
                const carIdParam = urlParams.get('carId');
                const startDateParam = urlParams.get('startDate');
                const endDateParam = urlParams.get('endDate');
                
                // Set car select value if carId is in URL
                if (carIdParam && carSelectEl) {
                    carSelectEl.value = carIdParam;
                    const carIdHidden = document.getElementById('carIdHidden');
                    if (carIdHidden) carIdHidden.value = carIdParam;
                }
                
                // Set dates from URL parameters if available
                if (startDateParam) {
                    const startDateInput = document.getElementById('startDate');
                    if (startDateInput) {
                        // Decode URL-encoded date (e.g., 2025-11-19T15%3A29 -> 2025-11-19T15:29)
                        const decodedStartDate = decodeURIComponent(startDateParam);
                        startDateInput.value = decodedStartDate;
                        console.log('Set startDate from URL:', decodedStartDate);
                    }
                }
                
                if (endDateParam) {
                    const endDateInput = document.getElementById('endDate');
                    if (endDateInput) {
                        // Decode URL-encoded date
                        const decodedEndDate = decodeURIComponent(endDateParam);
                        endDateInput.value = decodedEndDate;
                        console.log('Set endDate from URL:', decodedEndDate);
                    }
                }
                
                // Load available slots if car is already selected
                if (carSelectEl && (carSelectEl.value || carIdParam)) {
                    const carId = carSelectEl.value || carIdParam;
                    if (carId && carId !== '0' && carId !== '') {
                        loadAvailableSlots(carId);
                    }
                }
                
                // Initialize price calculation function
                function initPriceCalc() {
                    if (dailyRate > 0) {
                        // Already have rate, just calculate
                        console.log('Daily rate already set:', dailyRate);
                        // Wait a bit for Flatpickr to be ready, then calculate
                        setTimeout(() => {
                            console.log('Running calculatePrice on init...');
                            calculatePrice();
                            // If subscription is selected, trigger its change event to update info
                            setTimeout(() => {
                                const subscriptionSelect = document.getElementById('subscriptionSelect');
                                if (subscriptionSelect && subscriptionSelect.value) {
                                    subscriptionSelect.dispatchEvent(new Event('change'));
                                }
                            }, 100);
                        }, 300);
                    } else if (carSelectEl && (carSelectEl.value || carIdParam)) {
                        // Try to get car details if car is pre-selected
                        const carId = carSelectEl.value || carIdParam;
                        if (carSelectEl) carSelectEl.value = carId;
                        const carIdHidden = document.getElementById('carIdHidden');
                        if (carIdHidden) carIdHidden.value = carId;
                        console.log('Loading car from select or URL param:', carId);
                        loadCarDetailsAndCalculate(carId).then(() => {
                            // After car is loaded, wait for Flatpickr to sync dates, then calculate
                            setTimeout(() => {
                                console.log('Car loaded, syncing dates and calculating price...');
                                
                                // Sync dates with Flatpickr if they exist in URL
                                if (startDateParam && typeof startDatePicker !== 'undefined' && startDatePicker) {
                                    const startDate = new Date(decodeURIComponent(startDateParam));
                                    if (!isNaN(startDate.getTime())) {
                                        startDatePicker.setDate(startDate, false);
                                        console.log('Synced startDate to Flatpickr:', startDate);
                                    }
                                }
                                
                                if (endDateParam && typeof endDatePicker !== 'undefined' && endDatePicker) {
                                    const endDate = new Date(decodeURIComponent(endDateParam));
                                    if (!isNaN(endDate.getTime())) {
                                        endDatePicker.setDate(endDate, false);
                                        console.log('Synced endDate to Flatpickr:', endDate);
                                    }
                                }
                                
                                // Calculate price multiple times to ensure it updates
                                setTimeout(() => {
                                    console.log('First price calculation after car and dates loaded...');
                                    calculatePrice();
                                    
                                    // Force another calculation after a short delay
                                    setTimeout(() => {
                                        console.log('Second price calculation...');
                                        calculatePrice();
                                    }, 500);
                                }, 200);
                                
                                const subscriptionSelect = document.getElementById('subscriptionSelect');
                                if (subscriptionSelect && subscriptionSelect.value) {
                                    subscriptionSelect.dispatchEvent(new Event('change'));
                                }
                            }, 500);
                        });
                    } else {
                        // If no car selected, set rate to 0 and show empty calculator
                        console.log('No car selected, setting rate to 0');
                        dailyRate = 0;
                        calculatePrice();
                    }
                }
                
                // Run initialization
                initPriceCalc();
                
                // Also run after Flatpickr is fully initialized (safety check)
                setTimeout(() => {
                    console.log('Re-running price calc after Flatpickr init...');
                    initPriceCalc();
                }, 1000);
                
                // Also trigger calculation when dates are changed after Flatpickr is initialized
                setTimeout(() => {
                    if (typeof startDatePicker !== 'undefined' && typeof endDatePicker !== 'undefined') {
                        if (dailyRate > 0) {
                            // Calculate even if dates are not set yet (will show 0 if no dates)
                            console.log('Initial price calculation after Flatpickr initialization');
                            calculatePrice();
                        }
                        
                        // Monitor for date changes
                        if (startDatePicker.selectedDates.length > 0 && endDatePicker.selectedDates.length > 0) {
                            console.log('Recalculating price with dates after initialization');
                            calculatePrice();
                        }
                    }
                }, 1500);
                
                // Set up periodic price calculation checks (fallback for manual input)
                setInterval(() => {
                    if (dailyRate > 0) {
                        const startInput = document.getElementById('startDate');
                        const endInput = document.getElementById('endDate');
                        if (startInput && endInput && startInput.value && endInput.value) {
                            calculatePrice();
                        }
                    }
                }, 2000);
            }, 1000); // Increased timeout to ensure Flatpickr is initialized
            
            // Make calculatePrice and dailyRate available globally for Flatpickr callbacks
            window.calculatePrice = calculatePrice;
            window.dailyRateValue = () => dailyRate;
        });
    </script>
}
