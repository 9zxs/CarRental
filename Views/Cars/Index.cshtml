@model IEnumerable<Car>
@{
    ViewData["Title"] = "Available Vehicles - DriveLuxe";
    var fuelType = ViewBag.FuelType as string ?? "All";
    var states = ViewBag.States as List<string> ?? new List<string>();
    var categories = ViewBag.Categories as List<Category> ?? new List<Category>();
    var selectedState = ViewBag.SelectedState as string;
    var selectedCategoryId = ViewBag.SelectedCategoryId as int?;
    var searchQuery = ViewBag.SearchQuery as string;
    var minPrice = ViewBag.MinPrice as decimal?;
    var maxPrice = ViewBag.MaxPrice as decimal?;
    var minDailyRate = ViewBag.MinDailyRate as decimal? ?? 0;
    var maxDailyRate = ViewBag.MaxDailyRate as decimal? ?? 1000;
    var sortBy = ViewBag.SortBy as string ?? "price_asc";
}

@section Styles {
<style>
    :root {
        --primary: #135bec;
        --background-light: #f6f6f8;
        --background-dark: #101622;
    }

    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        vertical-align: middle;
    }

    body {
        font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .car-card {
        transition: all 0.3s ease;
        border: 1px solid #e7ebf3;
    }

    .car-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
        border-color: var(--primary);
    }

    .car-card img {
        transition: transform 0.3s ease;
    }

    .car-card:hover img {
        transform: scale(1.05);
    }

    .filter-btn-group {
        background: white;
        border: 1px solid #e7ebf3;
        border-radius: 9999px;
        padding: 4px;
        display: inline-flex;
    }

    .filter-btn {
        border: none;
        background: transparent;
        padding: 6px 16px;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .filter-btn.active {
        background: var(--primary);
        color: white;
        font-weight: 600;
    }

    .filter-btn:not(.active) {
        color: #6b7280;
    }

    .filter-btn:not(.active):hover {
        background: #f3f4f6;
    }
    
    /* Dark mode support */
    [data-theme="dark"] body {
        background: var(--bg-primary, #030712) !important;
        color: var(--text-primary, #f9fafb) !important;
    }
    
    /* CRITICAL: White car cards in dark mode need dark text */
    [data-theme="dark"] .car-card {
        background: white !important;
        border-color: #e5e7eb !important;
        color: #1f2937 !important;
    }
    
    [data-theme="dark"] .car-card * {
        color: #1f2937 !important;
    }
    
    [data-theme="dark"] .car-card .text-muted {
        color: #6b7280 !important;
    }
    
    [data-theme="dark"] .filter-btn-group {
        background: var(--bg-secondary, #1f2937) !important;
        border-color: var(--border-color, #374151) !important;
    }
    
    [data-theme="dark"] .filter-btn:not(.active) {
        color: var(--text-secondary, #d1d5db) !important;
    }
    
    [data-theme="dark"] .filter-btn:not(.active):hover {
        background: var(--bg-tertiary, #374151) !important;
    }
    
    [data-theme="dark"] .sort-btn {
        background: var(--bg-secondary, #1f2937) !important;
        border-color: var(--border-color, #374151) !important;
        color: var(--text-primary, #f9fafb) !important;
    }
    
    [data-theme="dark"] .sort-btn:hover {
        background: var(--bg-tertiary, #374151) !important;
    }

    .sort-btn {
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 9999px;
        padding: 8px 16px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }

    .sort-btn:hover {
        background: #f3f4f6;
    }

    .favorite-btn-car {
        transition: all 0.3s ease;
    }

    .favorite-btn-car:hover {
        background: rgba(255, 255, 255, 1) !important;
        transform: scale(1.1);
    }

    .favorite-btn-car .material-symbols-outlined {
        transition: all 0.3s ease;
    }

    .favorite-btn-car.favorited .material-symbols-outlined {
        color: #ef4444 !important;
        font-variation-settings: 'FILL' 1 !important;
    }
</style>
}


<div class="container py-4">
    <!-- Advanced Search Section -->
    <div class="card shadow-sm mb-4 border-0" style="border-radius: 1rem;">
        <div class="card-body p-4">
            <form asp-action="Index" method="get" id="searchForm">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">
                            <span class="material-symbols-outlined me-2" style="font-size: 1.2rem; vertical-align: middle;">search</span>
                            Search Vehicles
                        </label>
                        <input type="text" 
                               name="searchQuery" 
                               id="searchInput"
                               class="form-control form-control-lg" 
                               placeholder="Type to search by brand, model, city, state, year..."
                               value="@searchQuery"
                               autocomplete="off">
                        <small class="text-muted">Search is case-insensitive and searches across multiple fields</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">State</label>
                        <select name="state" id="stateFilter" class="form-select form-select-lg">
                            <option value="">All States</option>
                            @foreach (var state in states)
                            {
                                <option value="@state" selected="@(state == selectedState)">@state</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Category</label>
                        <select name="categoryId" id="categoryFilter" class="form-select form-select-lg">
                            <option value="">All Categories</option>
                            @foreach (var category in categories)
                            {
                                <option value="@category.Id" selected="@(category.Id == selectedCategoryId)">@category.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Min Price</label>
                        <input type="number" 
                               name="minPrice" 
                               id="minPriceInput"
                               class="form-control form-control-lg" 
                               placeholder="Min"
                               value="@minPrice"
                               step="0.01"
                               min="@minDailyRate"
                               max="@maxDailyRate">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Max Price</label>
                        <input type="number" 
                               name="maxPrice" 
                               id="maxPriceInput"
                               class="form-control form-control-lg" 
                               placeholder="Max"
                               value="@maxPrice"
                               step="0.01"
                               min="@minDailyRate"
                               max="@maxDailyRate">
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">
                            <span class="material-symbols-outlined me-2" style="font-size: 1rem; vertical-align: middle;">event</span>
                            Start Date
                        </label>
                        <input type="date" 
                               name="startDate" 
                               id="startDateInput"
                               class="form-control form-control-lg" 
                               value="@ViewBag.StartDate" />
                        <small class="text-muted">Filter by available slots</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">
                            <span class="material-symbols-outlined me-2" style="font-size: 1rem; vertical-align: middle;">history</span>
                            End Date
                        </label>
                        <input type="date" 
                               name="endDate" 
                               id="endDateInput"
                               class="form-control form-control-lg" 
                               value="@ViewBag.EndDate" />
                        <small class="text-muted">Only show available cars</small>
                    </div>
                </div>
                <input type="hidden" name="fuelType" value="@fuelType">
                <input type="hidden" name="sortBy" value="@sortBy" id="sortByInput">
                <div class="row g-3 mt-2">
                    <div class="col-12 d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div class="filter-btn-group">
                            <button type="button" 
                                    class="filter-btn @(fuelType == "All" || fuelType == null ? "active" : "")"
                                    onclick="setFuelType('All')">
                                All
                            </button>
                            <button type="button" 
                                    class="filter-btn @(fuelType == "Electric" ? "active" : "")"
                                    onclick="setFuelType('Electric')">
                                <i class="fas fa-bolt"></i> Electric
                            </button>
                            <button type="button" 
                                    class="filter-btn @(fuelType == "Gas" ? "active" : "")"
                                    onclick="setFuelType('Gas')">
                                <i class="fas fa-gas-pump"></i> Gas
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center gap-2" 
                                        type="button" 
                                        id="sortDropdown" 
                                        data-bs-toggle="dropdown">
                                    <span class="material-symbols-outlined">swap_vert</span>
                                    <span>Sort</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="setSort('price_asc'); return false;">
                                        <span class="material-symbols-outlined me-2">arrow_upward</span>Price: Low to High
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setSort('price_desc'); return false;">
                                        <span class="material-symbols-outlined me-2">arrow_downward</span>Price: High to Low
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setSort('name_asc'); return false;">
                                        <span class="material-symbols-outlined me-2">sort_by_alpha</span>Name: A-Z
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setSort('year_desc'); return false;">
                                        <span class="material-symbols-outlined me-2">calendar_today</span>Year: Newest
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setSort('rating_desc'); return false;">
                                        <span class="material-symbols-outlined me-2">star</span>Highest Rated
                                    </a></li>
                                </ul>
                            </div>
                            <button type="submit" class="btn btn-primary px-4">
                                <span class="material-symbols-outlined me-2">search</span>Search
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                <span class="material-symbols-outlined me-2">refresh</span>Reset
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1" style="font-size: 1.75rem; font-weight: 700;">Search Results</h2>
            <p class="text-muted mb-0">Found @Model.Count() vehicle(s)</p>
        </div>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> No cars available at the moment.
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var car in Model)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="car-card card h-100 shadow-sm overflow-hidden rounded-3 card-3d">
                        <div class="position-relative overflow-hidden" style="aspect-ratio: 16/9;">
                            <img src="@(car.ImageUrl ?? "https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?w=800")" 
                                 class="w-100 h-100" 
                                 alt="@car.DisplayName"
                                 style="object-fit: cover;">
                            @if (User.Identity!.IsAuthenticated && !User.IsInRole("Staff") && !User.IsInRole("Manager"))
                            {
                                var favoritedCarIds = ViewBag.FavoritedCarIds as HashSet<int> ?? new HashSet<int>();
                                var isFavorited = favoritedCarIds.Contains(car.Id);
                                <button class="btn position-absolute top-0 end-0 m-2 rounded-circle favorite-btn-car" 
                                        style="background: rgba(255, 255, 255, 0.9); border: none; width: 40px; height: 40px; z-index: 10;"
                                        data-car-id="@car.Id"
                                        onclick="toggleFavoriteCar(@car.Id, this)">
                                    <span class="material-symbols-outlined @(isFavorited ? "text-danger" : "text-muted")" 
                                          style="font-size: 20px; font-variation-settings: '@(isFavorited ? "FILL" : "FILL")' 1;">
                                        favorite
                                    </span>
                                </button>
                            }
                            @if (car.IsElectric)
                            {
                                <span class="badge bg-success position-absolute top-0 start-0 m-2">
                                    <i class="fas fa-bolt"></i> EV
                                </span>
                            }
                            @if (!car.IsAvailable)
                            {
                                <span class="badge bg-danger position-absolute top-0 start-0 m-2">
                                    Unavailable
                                </span>
                            }
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="card-title mb-1 fw-bold">@car.DisplayName</h5>
                                    <p class="text-muted small mb-0">@(car.Category?.Name ?? "Sedan")</p>
                                </div>
                                @if (ViewBag.AverageRatings != null && ViewBag.AverageRatings.ContainsKey(car.Id))
                                {
                                    var rating = (double)ViewBag.AverageRatings[car.Id];
                                    <div class="d-flex align-items-center gap-1">
                                        <span class="material-symbols-outlined text-warning" style="font-size: 18px; font-variation-settings: 'FILL' 1;">star</span>
                                        <span class="small fw-medium">@rating.ToString("F1")</span>
                                    </div>
                                }
                            </div>

                            <div class="mb-3 flex-grow-1">
                                <div class="d-flex align-items-center gap-3 text-muted small mb-2">
                                    <span class="d-flex align-items-center gap-1">
                                        <span class="material-symbols-outlined" style="font-size: 18px;">person</span>
                                        <span>5 Seats</span>
                                    </span>
                                    <span class="d-flex align-items-center gap-1">
                                        <span class="material-symbols-outlined" style="font-size: 18px;">settings</span>
                                        <span>Auto</span>
                                    </span>
                                </div>
                                @if (car.Description != null)
                                {
                                    <p class="text-muted small mb-0">@(car.Description.Length > 80 ? car.Description.Substring(0, 80) + "..." : car.Description)</p>
                                }
                            </div>

                            <div class="d-flex justify-content-between align-items-end mt-auto pt-3 border-top">
                                <div>
                                    <span class="h4 mb-0 fw-bold">$@car.DailyRate</span>
                                    <span class="text-muted small">/day</span>
                                </div>
                                @if (car.IsAvailable)
                                {
                                    <a asp-action="Details" asp-route-id="@car.Id" 
                                       class="btn btn-primary rounded-2 fw-bold" 
                                       style="background: var(--primary); border: none; padding: 8px 20px;">
                                        <span class="material-symbols-outlined me-1" style="font-size: 1rem; vertical-align: middle;">visibility</span>
                                        View Details
                                    </a>
                                }
                                else
                                {
                                    <button class="btn btn-secondary rounded-2 fw-bold" disabled>
                                        Unavailable
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        @* Pagination *@
        <nav aria-label="Pagination" class="mt-5 d-flex justify-content-center">
            <ul class="pagination">
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span class="material-symbols-outlined" style="font-size: 20px;">chevron_left</span>
                    </a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#" aria-label="Next">
                        <span class="material-symbols-outlined" style="font-size: 20px;">chevron_right</span>
                    </a>
                </li>
            </ul>
        </nav>
    }
</div>

@section Scripts {
    <script>
        async function toggleFavoriteCar(carId, btn) {
            const icon = btn.querySelector('.material-symbols-outlined');
            const isFavorited = btn.classList.contains('favorited');
            
            try {
                const response = await fetch(isFavorited ? 
                    `/Favorites/Remove?carId=${carId}` : 
                    `/Favorites/Add?carId=${carId}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (isFavorited) {
                        btn.classList.remove('favorited');
                        icon.style.color = '#6b7280';
                        icon.style.fontVariationSettings = "'FILL' 0";
                    } else {
                        btn.classList.add('favorited');
                        icon.style.color = '#ef4444';
                        icon.style.fontVariationSettings = "'FILL' 1";
                    }
                } else {
                    alert(data.message || 'Operation failed');
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                alert('An error occurred. Please try again.');
            }
        }

        function setFuelType(type) {
            document.querySelector('input[name="fuelType"]').value = type;
            document.getElementById('searchForm').submit();
        }

        function setSort(sort) {
            document.getElementById('sortByInput').value = sort;
            document.getElementById('searchForm').submit();
        }

        // Auto-submit on change - no need to click search button
        (function() {
            const searchInput = document.getElementById('searchInput');
            const stateFilter = document.getElementById('stateFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const minPriceInput = document.getElementById('minPriceInput');
            const maxPriceInput = document.getElementById('maxPriceInput');
            const searchForm = document.getElementById('searchForm');

            // Search on Enter key or blur (lose focus)
            if (searchInput && searchForm) {
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchForm.submit();
                    }
                });
                searchInput.addEventListener('blur', function() {
                    searchForm.submit();
                });
            }

            // Auto-submit when filters change - immediate, no delay
            if (stateFilter) {
                stateFilter.addEventListener('change', function() {
                    searchForm.submit();
                });
            }

            if (categoryFilter) {
                categoryFilter.addEventListener('change', function() {
                    searchForm.submit();
                });
            }

            // Date inputs - submit on change
            const startDateInput = document.getElementById('startDateInput');
            const endDateInput = document.getElementById('endDateInput');
            
            if (startDateInput) {
                startDateInput.addEventListener('change', function() {
                    const startDate = this.value;
                    const endDate = endDateInput?.value || '';
                    
                    if (startDate && endDate) {
                        if (new Date(startDate) >= new Date(endDate)) {
                            alert('Start date must be before end date!');
                            this.focus();
                            return;
                        }
                    }
                    
                    if (startDate && endDate) {
                        searchForm.submit();
                    }
                });
            }
            
            if (endDateInput) {
                endDateInput.addEventListener('change', function() {
                    const startDate = startDateInput?.value || '';
                    const endDate = this.value;
                    
                    if (startDate && endDate) {
                        if (new Date(startDate) >= new Date(endDate)) {
                            alert('Start date must be before end date!');
                            this.focus();
                            return;
                        }
                    }
                    
                    if (startDate && endDate) {
                        searchForm.submit();
                    }
                });
            }
            
            // Price inputs - submit on blur only (after user finishes typing)
            if (minPriceInput) {
                minPriceInput.addEventListener('blur', function() {
                    const minPrice = parseFloat(this.value) || 0;
                    const maxPrice = parseFloat(maxPriceInput?.value) || 0;
                    
                    if (minPrice > 0 && maxPrice > 0 && minPrice > maxPrice) {
                        alert('Minimum price cannot be greater than maximum price!');
                        this.focus();
                        return;
                    }
                    
                    searchForm.submit();
                });
            }

            if (maxPriceInput) {
                maxPriceInput.addEventListener('blur', function() {
                    const minPrice = parseFloat(minPriceInput?.value) || 0;
                    const maxPrice = parseFloat(this.value) || 0;
                    
                    if (minPrice > 0 && maxPrice > 0 && minPrice > maxPrice) {
                        alert('Minimum price cannot be greater than maximum price!');
                        this.focus();
                        return;
                    }
                    
                    searchForm.submit();
                });
            }
        })();
    </script>
}
